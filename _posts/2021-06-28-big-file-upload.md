---
layout: post
title:  "æ£é¼“ç³»åˆ—ï¼šå‰ç«¯å¤§æ–‡ä»¶ä¸Šä¼ "
date:   2021-06-28
categories: æŠ€æœ¯
excerpt: 'æŸä¸€å¤©ï¼Œåœ¨é€›æŸé‡‘çš„æ—¶å€™çªç„¶çœ‹åˆ°è¿™ç¯‡æ–‡ç« ï¼Œå‰ç«¯å¤§æ–‡ä»¶ä¸Šä¼ ï¼Œå¦‚æœä¸€ä¸ªæ–‡ä»¶å¤ªå¤§ï¼Œæ¯”å¦‚éŸ³è§†é¢‘æ•°æ®ã€ä¸‹è½½çš„excelè¡¨æ ¼ç­‰ç­‰ï¼Œå¦‚æœåœ¨ä¸Šä¼ çš„è¿‡ç¨‹ä¸­ï¼Œç­‰å¾…æ—¶é—´è¶…è¿‡30 ~ 120sï¼ŒæœåŠ¡å™¨æ²¡æœ‰æ•°æ®è¿”å›ï¼Œå°±æœ‰å¯èƒ½è¢«è®¤ä¸ºè¶…æ—¶ï¼Œè¿™æ˜¯ä¸Šä¼ çš„æ–‡ä»¶å°±ä¼šè¢«ä¸­æ–­ã€‚å¦å¤–ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œåœ¨å¤§æ–‡ä»¶ä¸Šä¼ çš„è¿‡ç¨‹ä¸­ï¼Œä¸Šä¼ åˆ°æœåŠ¡å™¨çš„æ•°æ®å› ä¸ºæœåŠ¡å™¨é—®é¢˜æˆ–è€…å…¶ä»–çš„ç½‘ç»œé—®é¢˜å¯¼è‡´ä¸­æ–­ã€è¶…æ—¶ï¼Œè¿™æ˜¯ä¸Šä¼ çš„æ•°æ®å°†ä¸ä¼šè¢«ä¿å­˜ï¼Œé€ æˆä¸Šä¼ çš„æµªè´¹ã€‚'
tag: [upload,big-file]
---

æŸä¸€å¤©ï¼Œåœ¨é€›æŸé‡‘çš„æ—¶å€™çªç„¶çœ‹åˆ°è¿™ç¯‡æ–‡ç« ï¼Œ[å‰ç«¯å¤§æ–‡ä»¶ä¸Šä¼ ](https://juejin.cn/post/6844903860327186445)ï¼Œä¹‹å‰ä¹Ÿç ”ç©¶è¿‡ç±»ä¼¼çš„åŸç†ï¼Œä½†æ˜¯ä¸€ç›´æ²¡èƒ½äº²æ‰‹åšä¸€æ¬¡ï¼Œå§‹ç»ˆæ„Ÿè§‰æœ‰ç‚¹è™šï¼Œæœ€è¿‘èŠ±äº†ç‚¹æ—¶é—´ï¼Œç²¾ï¼ˆç†¬ï¼‰å¿ƒï¼ˆå¤œï¼‰å‡†ï¼ˆè‚ï¼‰å¤‡ï¼ˆçˆ†ï¼‰äº†ä¸ªä¾‹å­ï¼Œæ¥å’Œå¤§å®¶åˆ†äº«ã€‚

æœ¬æ–‡ä»£ç ï¼š[github](https://github.com/Rynxiao/file-examples)

![upload1.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/87af19f97602463aba76faa43ec9bd0b~tplv-k3u1fbpfcp-watermark.image)
## é—®é¢˜

> Knowing the time available to provide a response can avoid problems with timeouts. Current implementations select times between **30 and 120** seconds
>
> [https://tools.ietf.org/id/draft-thomson-hybi-http-timeout-00.html](https://tools.ietf.org/id/draft-thomson-hybi-http-timeout-00.html)

å¦‚æœä¸€ä¸ªæ–‡ä»¶å¤ªå¤§ï¼Œæ¯”å¦‚éŸ³è§†é¢‘æ•°æ®ã€ä¸‹è½½çš„excelè¡¨æ ¼ç­‰ç­‰ï¼Œå¦‚æœåœ¨ä¸Šä¼ çš„è¿‡ç¨‹ä¸­ï¼Œç­‰å¾…æ—¶é—´è¶…è¿‡30 ~ 120sï¼ŒæœåŠ¡å™¨æ²¡æœ‰æ•°æ®è¿”å›ï¼Œå°±æœ‰å¯èƒ½è¢«è®¤ä¸ºè¶…æ—¶ï¼Œè¿™æ˜¯ä¸Šä¼ çš„æ–‡ä»¶å°±ä¼šè¢«ä¸­æ–­ã€‚

å¦å¤–ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œåœ¨å¤§æ–‡ä»¶ä¸Šä¼ çš„è¿‡ç¨‹ä¸­ï¼Œä¸Šä¼ åˆ°æœåŠ¡å™¨çš„æ•°æ®å› ä¸ºæœåŠ¡å™¨é—®é¢˜æˆ–è€…å…¶ä»–çš„ç½‘ç»œé—®é¢˜å¯¼è‡´ä¸­æ–­ã€è¶…æ—¶ï¼Œè¿™æ˜¯ä¸Šä¼ çš„æ•°æ®å°†ä¸ä¼šè¢«ä¿å­˜ï¼Œé€ æˆä¸Šä¼ çš„æµªè´¹ã€‚

## åŸç†

å¤§æ–‡ä»¶ä¸Šä¼ åˆ©ç”¨å°†å¤§æ–‡ä»¶åˆ†ç‰‡çš„åŸåˆ™ï¼Œå°†ä¸€ä¸ªå¤§æ–‡ä»¶æ‹†åˆ†æˆå‡ ä¸ªå°çš„æ–‡ä»¶åˆ†åˆ«ä¸Šä¼ ï¼Œç„¶ååœ¨å°æ–‡ä»¶ä¸Šä¼ å®Œæˆä¹‹åï¼Œé€šçŸ¥æœåŠ¡å™¨è¿›è¡Œæ–‡ä»¶åˆå¹¶ï¼Œè‡³æ­¤å®Œæˆå¤§æ–‡ä»¶ä¸Šä¼ ã€‚

è¿™ç§æ–¹å¼çš„ä¸Šä¼ è§£å†³äº†å‡ ä¸ªé—®é¢˜ï¼š

- æ–‡ä»¶å¤ªå¤§å¯¼è‡´çš„è¯·æ±‚è¶…æ—¶
- å°†ä¸€ä¸ªè¯·æ±‚æ‹†åˆ†æˆå¤šä¸ªè¯·æ±‚ï¼ˆç°åœ¨æ¯”è¾ƒæµè¡Œçš„æµè§ˆå™¨ï¼Œä¸€èˆ¬é»˜è®¤çš„æ•°é‡æ˜¯6ä¸ªï¼Œ[åŒæºè¯·æ±‚å¹¶å‘ä¸Šä¼ çš„æ•°é‡](https://docs.pushtechnology.com/cloud/latest/manual/html/designguide/solution/support/connection_limitations.html)ï¼‰ï¼Œå¢åŠ å¹¶å‘æ•°ï¼Œæå‡äº†æ–‡ä»¶ä¼ è¾“çš„é€Ÿåº¦
- å°æ–‡ä»¶çš„æ•°æ®ä¾¿äºæœåŠ¡å™¨ä¿å­˜ï¼Œå¦‚æœå‘ç”Ÿç½‘ç»œä¸­æ–­ï¼Œä¸‹æ¬¡ä¸Šä¼ æ—¶ï¼Œå·²ç»ä¸Šä¼ çš„æ•°æ®å¯ä»¥ä¸å†ä¸Šä¼ 

## å®ç°

### æ–‡ä»¶åˆ†ç‰‡

`File`æ¥å£æ˜¯åŸºäº`Blob`çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†ä¸Šä¼ çš„æ–‡ä»¶å¯¹è±¡ä½¿ç”¨`slice`æ–¹æ³• è¿›è¡Œåˆ†å‰²ï¼Œå…·ä½“çš„å®ç°å¦‚ä¸‹ï¼š

```js
export const slice = (file, piece = CHUNK_SIZE) => {
  return new Promise((resolve, reject) => {
    let totalSize = file.size;
    const chunks = [];
    const blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice;
    let start = 0;
    const end = start + piece >= totalSize ? totalSize : start + piece;

    while (start < totalSize) {
        const chunk = blobSlice.call(file, start, end);
        chunks.push(chunk);

        start = end;
        const end = start + piece >= totalSize ? totalSize : start + piece;
    }
    
    resolve(chunks);
  });
};
```

ç„¶åå°†æ¯ä¸ªå°çš„æ–‡ä»¶ï¼Œä½¿ç”¨è¡¨å•çš„æ–¹å¼ä¸Šä¼ 

```js
_chunkUploadTask(chunks) {
    for (let chunk of chunks) {
        const fd = new FormData();
        fd.append('chunk', chunk);

        return axios({
          url: '/upload',
          method: 'post',
          data: fd,
        })
          .then((res) => res.data)
          .catch((err) => {});
    }
}
```

åç«¯é‡‡ç”¨äº†`express`ï¼Œæ¥æ”¶æ–‡ä»¶é‡‡ç”¨äº†`[multer](https://github.com/expressjs/multer)`è¿™ä¸ª åº“

`multer`ä¸Šä¼ çš„çš„æ–¹å¼æœ‰singleã€arrayã€fieldsã€noneã€anyï¼Œåšå•æ–‡ä»¶ä¸Šä¼ ï¼Œé‡‡ç”¨`single`å’Œ`array`çš†å¯ï¼Œä½¿ç”¨æ¯”è¾ƒç®€ä¾¿ï¼Œé€šè¿‡`req.file` æˆ– `req.files`æ¥æ‹¿åˆ°ä¸Šä¼ æ–‡ä»¶çš„ä¿¡æ¯

å¦å¤–éœ€è¦é€šè¿‡`disk storage`æ¥å®šåˆ¶åŒ–ä¸Šä¼ æ–‡ä»¶çš„æ–‡ä»¶åï¼Œä¿è¯åœ¨æ¯ä¸ªä¸Šä¼ çš„æ–‡ä»¶chunkéƒ½æ˜¯å”¯ä¸€çš„ã€‚

```js
const storage = multer.diskStorage({
  destination: uploadTmp,
  filename: (req, file, cb) => {
    // æŒ‡å®šè¿”å›çš„æ–‡ä»¶åï¼Œå¦‚æœä¸æŒ‡å®šï¼Œé»˜è®¤ä¼šéšæœºç”Ÿæˆ
    cb(null, file.fieldname);
  },
});
const multerUpload = multer({ storage });

// router
router.post('/upload', multerUpload.any(), uploadService.uploadChunk);

// service
uploadChunk: async (req, res) => {
  const file = req.files[0];
  const chunkName = file.filename;

  try {
    const checksum = req.body.checksum;
    const chunkId = req.body.chunkId;

    const message = Messages.success(modules.UPLOAD, actions.UPLOAD, chunkName);
    logger.info(message);
    res.json({ code: 200, message });
  } catch (err) {
    const errMessage = Messages.fail(modules.UPLOAD, actions.UPLOAD, err);
    logger.error(errMessage);
    res.json({ code: 500, message: errMessage });
    res.status(500);
  }
}
```

ä¸Šä¼ çš„æ–‡ä»¶ä¼šè¢«ä¿å­˜åœ¨`uploads/tmp`ä¸‹ï¼Œè¿™é‡Œæ˜¯ç”±`multer`è‡ªåŠ¨å¸®æˆ‘ä»¬å®Œæˆçš„ï¼ŒæˆåŠŸä¹‹åï¼Œé€šè¿‡`req.files`èƒ½å¤Ÿè·å–åˆ°æ–‡ä»¶çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬chunkçš„åç§°ã€è·¯å¾„ç­‰ç­‰ï¼Œæ–¹ä¾¿åšåç»­çš„å­˜åº“å¤„ç†ã€‚

ä¸ºä»€ä¹ˆè¦ä¿è¯chunkçš„æ–‡ä»¶åå”¯ä¸€ï¼Ÿ

- å› ä¸ºæ–‡ä»¶åæ˜¯éšæœºçš„ï¼Œä»£è¡¨ç€ä¸€æ—¦å‘ç”Ÿç½‘ç»œä¸­æ–­ï¼Œå¦‚æœä¸Šä¼ çš„åˆ†ç‰‡è¿˜æ²¡æœ‰å®Œæˆï¼Œè¿™æ—¶æ•°æ®åº“ä¹Ÿä¸ä¼šæœ‰ç›¸åº”çš„å­˜ç‰‡è®°å½•ï¼Œå¯¼è‡´åœ¨ä¸‹æ¬¡ä¸Šä¼ çš„æ—¶å€™æ‰¾ä¸åˆ°åˆ†ç‰‡ã€‚è¿™æ ·çš„åæœæ˜¯ï¼Œä¼šåœ¨`tmp`ç›®å½•ä¸‹å­˜åœ¨ç€å¾ˆå¤šæ¸¸ç¦»çš„åˆ†ç‰‡ï¼Œè€Œå¾—ä¸åˆ°åˆ é™¤ã€‚
- åŒæ—¶åœ¨ä¸Šä¼ æš‚åœçš„æ—¶å€™ï¼Œä¹Ÿèƒ½æ ¹æ®chunkçš„åç§°æ¥åˆ é™¤ç›¸åº”çš„ä¸´æ—¶åˆ†ç‰‡ï¼ˆè¿™æ­¥å¯ä»¥ä¸éœ€è¦ï¼Œ`multer`åˆ¤æ–­åˆ†ç‰‡å­˜åœ¨çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨è¦†ç›–ï¼‰

å¦‚ä½•ä¿è¯chunkå”¯ä¸€ï¼Œæœ‰ä¸¤ä¸ªåŠæ³•ï¼Œ

- åœ¨åšæ–‡ä»¶åˆ‡å‰²çš„æ—¶å€™ï¼Œç»™æ¯ä¸ªchunkç”Ÿæˆæ–‡ä»¶æŒ‡çº¹ ï¼ˆ`chunkmd5`)
- é€šè¿‡æ•´ä¸ªæ–‡ä»¶çš„æ–‡ä»¶æŒ‡çº¹ï¼ŒåŠ ä¸Šchunkçš„åºåˆ—å·æŒ‡å®šï¼ˆ`filemd5` + `chunkIndex`ï¼‰

```jsx
// ä¿®æ”¹ä¸Šè¿°çš„ä»£ç 
const chunkName = `${chunkIndex}.${filemd5}.chunk`;
const fd = new FormData();
fd.append(chunkName, chunk);
```

è‡³æ­¤åˆ†ç‰‡ä¸Šä¼ å°±å¤§è‡´å®Œæˆäº†ã€‚

### æ–‡ä»¶åˆå¹¶

æ–‡ä»¶åˆå¹¶ï¼Œå°±æ˜¯å°†ä¸Šä¼ çš„æ–‡ä»¶åˆ†ç‰‡åˆ†åˆ«è¯»å–å‡ºæ¥ï¼Œç„¶åæ•´åˆæˆä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œ**æ¯”è¾ƒè€—IO**ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªæ–°çš„çº¿ç¨‹ä¸­å»æ•´åˆã€‚

```js
for (let chunkId = 0; chunkId < chunks; chunkId++) {
  const file = `${uploadTmp}/${chunkId}.${checksum}.chunk`;
  const content = await fsPromises.readFile(file);
  logger.info(Messages.success(modules.UPLOAD, actions.GET, file));
  try {
    await fsPromises.access(path, fs.constants.F_OK);
    await appendFile({ path, content, file, checksum, chunkId });
    if (chunkId === chunks - 1) {
        res.json({ code: 200, message });
    }
  } catch (err) {
    await createFile({ path, content, file, checksum, chunkId });
  }
}

Promise.all(tasks).then(() => {
  // when status in uploading, can send /makefile request
  // if not, when status in canceled, send request will delete chunk which has uploaded.
  if (this.status === fileStatus.UPLOADING) {
    const data = { chunks: this.chunks.length, filename, checksum: this.checksum };
    axios({
      url: '/makefile',
      method: 'post',
      data,
    })
      .then((res) => {
        if (res.data.code === 200) {
          this._setDoneProgress(this.checksum, fileStatus.DONE);
          toastr.success(`file ${filename} upload successfully!`);
        }
      })
      .catch((err) => {
        console.error(err);
        toastr.error(`file ${filename} upload failed!`);
      });
  }
});
```

- é¦–å…ˆä½¿ç”¨accessåˆ¤æ–­åˆ†ç‰‡æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–°æ–‡ä»¶å¹¶è¯»å–åˆ†ç‰‡å†…å®¹
- å¦‚æœchunkæ–‡ä»¶å­˜åœ¨ï¼Œåˆ™è¯»å–å†…å®¹åˆ°æ–‡ä»¶ä¸­
- æ¯ä¸ªchunkè¯»å–æˆåŠŸä¹‹åï¼Œåˆ é™¤chunk

è¿™é‡Œæœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š

- å¦‚æœä¸€ä¸ªæ–‡ä»¶åˆ‡å‰²å‡ºæ¥åªæœ‰ä¸€ä¸ªchunkï¼Œé‚£ä¹ˆå°±éœ€è¦åœ¨`createFile`çš„æ—¶å€™è¿›è¡Œè¿”å›ï¼Œå¦åˆ™è¯·æ±‚ä¸€ç›´å¤„äº`pending`çŠ¶æ€ã€‚

    ```js
    await createFile({ path, content, file, checksum, chunkId });

    if (chunks.length === 1) {
      res.json({ code: 200, message });
    }
    ```

- `makefile`ä¹‹å‰åŠ¡å¿…è¦åˆ¤æ–­æ–‡ä»¶æ˜¯å¦æ˜¯ä¸Šä¼ çŠ¶æ€ï¼Œä¸ç„¶åœ¨`cancel`çš„çŠ¶æ€ä¸‹ï¼Œè¿˜ä¼šç»§ç»­ä¸Šä¼ ï¼Œå¯¼è‡´chunkä¸Šä¼ ä¹‹åï¼Œchunkæ–‡ä»¶è¢«åˆ é™¤ï¼Œä½†æ˜¯åœ¨æ•°æ®åº“ä¸­å´å­˜åœ¨è®°å½•ï¼Œè¿™æ ·åˆå¹¶å‡ºæ¥çš„æ–‡ä»¶æ˜¯æœ‰é—®é¢˜çš„ã€‚

### æ–‡ä»¶ç§’ä¼ 

![upload4.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/849af4c772744a2c98238e9ed961085e~tplv-k3u1fbpfcp-watermark.image)

å¦‚ä½•åšåˆ°æ–‡ä»¶ç§’ä¼ ï¼Œæ€è€ƒä¸‰ç§’ï¼Œå…¬å¸ƒç­”æ¡ˆï¼Œ3. 2. 1.....ï¼Œå…¶å®åªæ˜¯ä¸ªéšœçœ¼æ³•ã€‚

ä¸ºå•¥è¯´æ˜¯ä¸ªéšœçœ¼æ³•ï¼Œå› ä¸ºæ ¹æœ¬å°±æ²¡æœ‰ä¼ ï¼Œæ–‡ä»¶æ˜¯ä»æœåŠ¡å™¨æ¥çš„ã€‚è¿™å°±æœ‰å‡ ä¸ªé—®é¢˜éœ€è¦å¼„æ¸…æ¥šï¼Œ

- æ€ä¹ˆç¡®å®šæ–‡ä»¶æ˜¯æœåŠ¡å™¨ä¸­å·²ç»å­˜åœ¨äº†çš„ï¼Ÿ
- æ–‡ä»¶çš„ä¸Šä¼ çš„ä¿¡æ¯æ˜¯ä¿å­˜åœ¨æ•°æ®åº“ä¸­è¿˜æ˜¯å®¢æˆ·ç«¯ï¼Ÿ
- æ–‡ä»¶åä¸ç›¸åŒï¼Œå†…å®¹ç›¸åŒï¼Œåº”è¯¥æ€ä¹ˆå¤„ç†ï¼Ÿ

**é—®é¢˜ä¸€ï¼šæ€ä¹ˆåˆ¤æ–­æ–‡ä»¶å·²ç»å­˜åœ¨äº†ï¼Ÿ**

å¯ä»¥ä¸ºæ¯ä¸ªæ–‡ä»¶ä¸Šä¼ ç”Ÿæˆå¯¹åº”çš„æŒ‡çº¹ï¼Œä½†æ˜¯å¦‚æœæ–‡ä»¶å¤ªå¤§ï¼Œå®¢æˆ·ç«¯ç”ŸæˆæŒ‡çº¹çš„æ—¶é—´å°†å¤§å¤§å¢åŠ ï¼Œæ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ

è¿˜è®°å¾—ä¹‹å‰çš„`slice`ï¼Œæ–‡ä»¶åˆ‡ç‰‡ä¹ˆï¼Ÿå¤§æ–‡ä»¶ä¸å¥½åšï¼ŒåŒæ ·çš„æ€è·¯ï¼Œåˆ‡æˆå°æ–‡ä»¶ï¼Œç„¶åè®¡ç®—md5å€¼å°±å¥½äº†ã€‚è¿™é‡Œä½¿ç”¨[`spark-md5`](http://github.com/satazor/js-spark-md5)è¿™ä¸ªåº“æ¥ç”Ÿæˆæ–‡ä»¶hashã€‚æ”¹é€ ä¸Šé¢çš„sliceæ–¹æ³•ã€‚

```jsx
export const checkSum = (file, piece = CHUNK_SIZE) => {
  return new Promise((resolve, reject) => {
    let totalSize = file.size;
    let start = 0;
    const blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice;
    const chunks = [];
    const spark = new SparkMD5.ArrayBuffer();
    const fileReader = new FileReader();

    const loadNext = () => {
      const end = start + piece >= totalSize ? totalSize : start + piece;
      const chunk = blobSlice.call(file, start, end);

      start = end;
      chunks.push(chunk);
      fileReader.readAsArrayBuffer(chunk);
    };

    fileReader.onload = (event) => {
      spark.append(event.target.result);

      if (start < totalSize) {
        loadNext();
      } else {
        const checksum = spark.end();
        resolve({ chunks, checksum });
      }
    };

    fileReader.onerror = () => {
      console.warn('oops, something went wrong.');
      reject();
    };

    loadNext();
  });
};
```

**é—®é¢˜äºŒï¼šæ–‡ä»¶çš„ä¸Šä¼ çš„ä¿¡æ¯æ˜¯ä¿å­˜åœ¨æ•°æ®åº“ä¸­è¿˜æ˜¯å®¢æˆ·ç«¯ï¼Ÿ**

æ–‡ä»¶ä¸Šä¼ çš„ä¿¡æ¯æœ€å¥½æ˜¯ä¿å­˜åœ¨**æœåŠ¡ç«¯çš„**æ•°æ®åº“ä¸­ï¼ˆå®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨`IndexDB`ï¼‰ï¼Œè¿™æ ·åšæœ‰å‡ ä¸ªä¼˜ç‚¹ï¼Œ

- æ•°æ®åº“æœåŠ¡æä¾›äº†æˆå¥—çš„`CRUD`ï¼Œæ–¹ä¾¿æ•°æ®çš„æ“ä½œ
- å½“ç”¨æˆ·åˆ·æ–°æµè§ˆå™¨ä¹‹åï¼Œæˆ–è€…æ›´æ¢æµè§ˆå™¨ä¹‹åï¼Œæ–‡ä»¶ä¸Šä¼ çš„ä¿¡æ¯ä¸ä¼šä¸¢å¤±

è¿™é‡Œä¸»è¦å¼ºè°ƒçš„æ˜¯ç¬¬äºŒç‚¹ï¼Œå› ä¸ºç¬¬ä¸€æ¡å®¢æˆ·ç«¯ä¹Ÿå¯ä»¥åšğŸ˜ğŸ˜ğŸ˜

```jsx
const saveFileRecordToDB = async (params) => {
  const { filename, checksum, chunks, isCopy, res } = params;
  await uploadRepository.create({ name: filename, checksum, chunks, isCopy });

  const message = Messages.success(modules.UPLOAD, actions.UPLOAD, filename);
  logger.info(message);
  res.json({ code: 200, message });
};
```

**é—®é¢˜ä¸‰ï¼šæ–‡ä»¶åä¸ç›¸åŒï¼Œå†…å®¹ç›¸åŒï¼Œåº”è¯¥æ€ä¹ˆå¤„ç†ï¼Ÿ**

è¿™é‡ŒåŒæ ·æœ‰ä¸¤ä¸ªè§£å†³åŠæ³•ï¼š

- æ–‡ä»¶copyï¼Œç›´æ¥å°†æ–‡ä»¶å¤åˆ¶ä¸€ä»½ï¼Œç„¶åæ›´æ–°æ•°æ®åº“è®°å½•ï¼Œå¹¶ä¸”åŠ ä¸Š`isCopy`çš„æ ‡è¯†
- æ–‡ä»¶å¼•ç”¨ï¼Œæ•°æ®åº“ä¿å­˜è®°å½•ï¼ŒåŠ ä¸Š`isCopy`å’Œ`linkTo`çš„æ ‡è¯†

è¿™ä¸¤ç§æ–¹å¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼š

ä½¿ç”¨æ–‡ä»¶copyçš„æ–¹å¼ï¼Œåœ¨åˆ é™¤æ–‡ä»¶çš„æ—¶å€™ä¼šæ›´åŠ è‡ªç”±ç‚¹ï¼Œå› ä¸ºåŸå§‹æ–‡ä»¶å’Œå¤åˆ¶çš„æ–‡ä»¶éƒ½æ˜¯ç‹¬ç«‹å­˜åœ¨çš„ï¼Œåˆ é™¤ä¸ä¼šç›¸äº’å¹²æ¶‰ï¼Œç¼ºç‚¹æ˜¯ä¼šå­˜åœ¨å¾ˆå¤šå†…å®¹ç›¸åŒçš„æ–‡ä»¶ï¼›

ä½†æ˜¯ä½¿ç”¨å¼•ç”¨æ–¹å¼å¤åˆ¶çš„æ–‡ä»¶çš„åˆ é™¤å°±æ¯”è¾ƒéº»çƒ¦ï¼Œå¦‚æœåˆ é™¤çš„æ˜¯å¤åˆ¶çš„æ–‡ä»¶å€’è¿˜å¥½ï¼Œåˆ é™¤çš„å¦‚æœæ˜¯åŸå§‹æ–‡ä»¶ï¼Œ**å°±å¿…é¡»å…ˆå°†æºæ–‡ä»¶copyä¸€ä»½åˆ°ä»»æ„çš„ä¸€ä¸ªå¤åˆ¶æ–‡ä»¶ä¸­**ï¼Œ**åŒæ—¶ä¿®æ”¹è´Ÿè´£çš„è®°å½•ä¸­çš„`isCopy`ä¸º`false`**, ç„¶åæ‰èƒ½åˆ é™¤åŸæ–‡ä»¶çš„æ•°æ®åº“è®°å½•ã€‚

è¿™é‡Œåšäº†ä¸ªå›¾ï¼Œé¡ºä¾¿è´´ä¸‹ï¼š

![fileCopy](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8e362a7abb4641258dd23a89ec59ce2e~tplv-k3u1fbpfcp-watermark.image)

ç†è®ºä¸Šè®²ï¼Œæ–‡ä»¶å¼•ç”¨çš„æ–¹å¼å¯èƒ½æ›´åŠ å¥½ä¸€ç‚¹ï¼Œè¿™é‡Œå·äº†ä¸ªæ‡’ï¼Œé‡‡ç”¨äº†æ–‡ä»¶å¤åˆ¶çš„æ–¹å¼ã€‚

```jsx
// å®¢æˆ·ç«¯
uploadFileInSecond() {
  const id = ID();
  const filename = this.file.name;
  this._renderProgressBar(id);

  const names = this.serverFiles.map((file) => file.name);
  if (names.indexOf(filename) === -1) {
    const sourceFilename = names[0];
    const targetFilename = filename;

    this._setDoneProgress(id, fileStatus.DONE_IN_SECOND);
    axios({
      url: '/copyfile',
      method: 'get',
      params: { targetFilename, sourceFilename, checksum: this.checksum },
    })
      .then((res) => {
        if (res.data.code === 200) {
          toastr.success(`file ${filename} upload successfully!`);
        }
      })
      .catch((err) => {
        console.error(err);
        toastr.error(`file ${filename} upload failed!`);
      });
  } else {
    this._setDoneProgress(id, fileStatus.EXISTED);
    toastr.success(`file ${filename} has existed`);
  }
}

// æœåŠ¡å™¨ç«¯
copyFile: async (req, res) => {
  const sourceFilename = req.query.sourceFilename;
  const targetFilename = req.query.targetFilename;
  const checksum = req.query.checksum;
  const sourceFile = `${uploadPath}/${sourceFilename}`;
  const targetFile = `${uploadPath}/${targetFilename}`;

  try {
    await fsPromises.copyFile(sourceFile, targetFile);
    await saveFileRecordToDB({ filename: targetFilename, checksum, chunks: 0, isCopy: true, res });
  } catch (err) {
    const message = Messages.fail(modules.UPLOAD, actions.UPLOAD, err.message);
    logger.info(message);
    res.json({ code: 500, message });
    res.status(500);
  }
}
```

### æ–‡ä»¶ä¸Šä¼ æš‚åœä¸æ–‡ä»¶ç»­ä¼ 

æ–‡ä»¶ä¸Šä¼ æš‚åœï¼Œå…¶å®æ˜¯åˆ©ç”¨äº†`xhr`çš„`abort`æ–¹æ³•ï¼Œå› ä¸ºåœ¨æ¡ˆä¾‹ä¸­é‡‡ç”¨çš„æ˜¯`axios`ï¼Œ`axios`åŸºäº`ajax`å°è£…äº†è‡ªå·±çš„å®ç°æ–¹å¼ã€‚

è¿™é‡Œçœ‹çœ‹ä»£ç æš‚åœä»£ç ï¼š

```jsx
const CancelToken = axios.CancelToken;

axios({
  url: '/upload',
  method: 'post',
  data: fd,
  cancelToken: new CancelToken((c) => {
    // An executor function receives a cancel function as a parameter
    canceler = c;
    this.cancelers.push(canceler);
  }),
})
```

`axios`åœ¨æ¯ä¸ªè¯·æ±‚ä¸­ä½¿ç”¨äº†ä¸€ä¸ªå‚æ•°`cancelToken`ï¼Œè¿™ä¸ª`cancelToken`æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥åˆ©ç”¨è¿™ä¸ªå‡½æ•°æ¥ä¿å­˜æ¯ä¸ªè¯·æ±‚çš„`cancel`å¥æŸ„ã€‚

ç„¶ååœ¨ç‚¹å‡»å–æ¶ˆçš„æ—¶å€™ï¼Œå–æ¶ˆæ¯ä¸ªchunkçš„ä¸Šä¼ ï¼Œå¦‚ä¸‹ï¼š

```jsx
// è¿™é‡Œä½¿ç”¨äº†jqueryæ¥ç¼–å†™htmlï¼Œå¥½å§ï¼Œç¡®å®å†™ğŸ¤®äº†

$(`#cancel${id}`).on('click', (event) => {
  const $this = $(event.target);
  $this.addClass('hidden');
  $this.next('.resume').removeClass('hidden');

  this.status = fileStatus.CANCELED;
  if (this.cancelers.length > 0) {
    for (const canceler of this.cancelers) {
      canceler();
    }
  }
});
```

åœ¨æ¯ä¸ªchunkä¸Šä¼ çš„åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦åˆ¤æ–­æ¯ä¸ªchunkæ˜¯å¦å­˜åœ¨ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ

å› ä¸ºå‘ç”Ÿæ„å¤–çš„ç½‘ç»œä¸­æ–­ï¼Œä¸Šä¼ åˆ°chunkä¿¡æ¯å°±ä¼šè¢«ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œæ‰€ä»¥åœ¨åšç»­ä¼ çš„æ—¶å€™ï¼Œå·²ç»å­˜åœ¨çš„chunkå°±å¯ä»¥ä¸ç”¨å†ä¼ äº†ï¼ŒèŠ‚çœäº†æ—¶é—´ã€‚

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæ˜¯æ¯ä¸ªchunkå•ä¸€æ£€æµ‹ï¼Œè¿˜æ˜¯é¢„å…ˆæ£€æµ‹æœåŠ¡å™¨ä¸­å·²ç»å­˜åœ¨çš„chunksï¼Ÿ

è¿™ä¸ªé—®é¢˜ä¹Ÿå¯ä»¥æ€è€ƒä¸‰ç§’ï¼Œæ¯•ç«Ÿdebugäº†å¥½ä¹…ã€‚

3.. 2.. 1......

çœ‹ä¸ªäººçš„ä»£ç ç­–ç•¥ï¼Œå› ä¸ºæ¯•ç«Ÿæ¯ä¸ªäººå†™ä»£ç çš„æ–¹å¼ä¸åŒã€‚åŸåˆ™æ˜¯ï¼Œ**ä¸èƒ½é˜»å¡æ¯æ¬¡çš„å¾ªç¯ï¼Œå› ä¸ºåœ¨å¾ªç¯ä¸­éœ€è¦ç”Ÿæˆæ¯ä¸ªchunkçš„`cancelToken`**ï¼Œå¦‚æœåœ¨å¾ªç¯ä¸­ï¼Œæ¯ä¸ªchunkéƒ½è¦ä»æœåŠ¡å™¨ä¸­æ‹¿ä¸€éæ•°æ®ï¼Œä¼šå¯¼è‡´åç»­çš„chunkç”Ÿæˆä¸äº†cancelTokenï¼Œè¿™æ ·åœ¨ç‚¹å‡»äº†cancelçš„æ—¶å€™ï¼Œåç»­çš„chunkè¿˜æ˜¯èƒ½å¤Ÿç»§ç»­ä¸Šä¼ ã€‚

```js
// å®¢æˆ·ç«¯
const chunksExisted = await this._isChunksExists();

for (let chunkId = 0; chunkId < this.chunks.length; chunkId++) {
  const chunk = this.chunks[chunkId];
  // å¾ˆæ—©ä¹‹å‰çš„ä»£ç æ˜¯è¿™æ ·çš„
  // è¿™é‡Œä¼šé˜»å¡cancelTokençš„ç”Ÿæˆ
  // const chunkExists = await isChunkExisted(this.checksum, chunkId);

  const chunkExists = chunksExisted[chunkId];

  if (!chunkExists) {
    const task = this._chunkUploadTask({ chunk, chunkId });
    tasks.push(task);
  } else {
    // if chunk is existed, need to set the with of chunk progress bar
    this._setUploadingChunkProgress(this.checksum, chunkId, 100);
    this.progresses[chunkId] = chunk.size;
  }
}

// æœåŠ¡å™¨ç«¯
chunksExist: async (req, res) => {
  const checksum = req.query.checksum;
  try {
    const chunks = await chunkRepository.findAllBy({ checksum });
    const exists = chunks.reduce((cur, chunk) => {
      cur[chunk.chunkId] = true;
      return cur;
    }, {});
    const message = Messages.success(modules.UPLOAD, actions.CHECK, `chunk ${JSON.stringify(exists)} exists`);
    logger.info(message);
    res.json({ code: 200, message: message, data: exists });
  } catch (err) {
    const errMessage = Messages.fail(modules.UPLOAD, actions.CHECK, err);
    logger.error(errMessage);
    res.json({ code: 500, message: errMessage });
    res.status(500);
  }
}
```

æ–‡ä»¶ç»­ä¼ å°±æ˜¯é‡æ–°ä¸Šä¼ æ–‡ä»¶ï¼Œè¿™ç‚¹æ²¡æœ‰ä»€ä¹ˆå¯ä»¥è®²çš„ï¼Œä¸»è¦æ˜¯è¦æŠŠä¸Šé¢çš„é‚£ä¸ªé—®é¢˜è§£å†³äº†ã€‚

```js
$(`#resume${id}`).on('click', async (event) => {
  const $this = $(event.target);
  $this.addClass('hidden');
  $this.prev('.cancel').removeClass('hidden');

  this.status = fileStatus.UPLOADING;
  await this.uploadFile();
});
```

### è¿›åº¦å›ä¼ 

è¿›åº¦å›ä¼ æ˜¯åˆ©ç”¨äº†`XMLHttpRequest.upload`ï¼Œ`axios`åŒæ ·å°è£…äº†ç›¸åº”çš„æ–¹æ³•ï¼Œè¿™é‡Œéœ€è¦æ˜¾ç¤ºä¸¤ä¸ªè¿›åº¦

- æ¯ä¸ªchunkçš„è¿›åº¦
- æ‰€æœ‰chunkçš„æ€»è¿›åº¦

æ¯ä¸ªchunkçš„è¿›åº¦ä¼šæ ¹æ®ä¸Šä¼ çš„`loaded`å’Œ`total`æ¥è¿›è¡Œè®¡ç®—ï¼Œè¿™é‡Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¥½è¯´çš„ã€‚

```js
axios({
  url: '/upload',
  method: 'post',
  data: fd,
  onUploadProgress: (progressEvent) => {
    const loaded = progressEvent.loaded;
    const chunkPercent = ((loaded / progressEvent.total) * 100).toFixed(0);

    this._setUploadingChunkProgress(this.checksum, chunkId, chunkPercent);
  },
})
```

æ€»è¿›åº¦åˆ™æ˜¯æ ¹æ®æ¯ä¸ªchunkçš„åŠ è½½é‡ï¼Œè¿›è¡Œç´¯åŠ ï¼Œç„¶ååœ¨å’Œ`file.size`æ¥è¿›è¡Œè®¡ç®—ã€‚

```js
constructor(checksum, chunks, file) {
  this.progresses = Array(this.chunks.length).fill(0);
}

axios({
  url: '/upload',
  method: 'post',
  data: fd,
  onUploadProgress: (progressEvent) => {
    const chunkProgress = this.progresses[chunkId];
    const loaded = progressEvent.loaded;
    this.progresses[chunkId] = loaded >= chunkProgress ? loaded : chunkProgress;
    const percent = ((this._getCurrentLoaded(this.progresses) / this.file.size) * 100).toFixed(0);

    this._setUploadingProgress(this.checksum, percent);
  },
})

_setUploadingProgress(id, percent) {
  // ...

  // for some reason, progressEvent.loaded bytes will greater than file size
  const isUploadChunkDone = Number(percent) >= 100;
  // 1% to make file
  const ratio = isUploadChunkDone ? 99 : percent;
}
```

è¿™é‡Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œ`loaded >= chunkProgress ? loaded : chunkProgress`ï¼Œè¿™æ ·åˆ¤æ–­çš„ç›®çš„æ˜¯ï¼Œå› ä¸ºç»­ä¼ çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰å¯èƒ½æŸäº›ç‰‡éœ€è¦é‡æ–°é‡`**0**`å¼€å§‹ä¸Šä¼ ï¼Œå¦‚æœä¸è¿™æ ·åˆ¤æ–­ï¼Œå°±ä¼šå¯¼è‡´è¿›åº¦æ¡çš„è·³åŠ¨ã€‚

### æ•°æ®åº“é…ç½®

æ•°æ®åº“é‡‡ç”¨äº†`sequelize` + `mysql`ï¼Œåˆå§‹åŒ–ä»£ç å¦‚ä¸‹ï¼š

```js
const initialize = async () => {
  // create db if it doesn't already exist
  const { DATABASE, USER, PASSWORD, HOST } = config;
  const connection = await mysql.createConnection({ host: HOST, user: USER, password: PASSWORD });
  try {
    await connection.query(`CREATE DATABASE IF NOT EXISTS ${DATABASE};`);
  } catch (err) {
    logger.error(Messages.fail(modules.DB, actions.CONNECT, `create database ${DATABASE}`));
    throw err;
  }

  // connect to db
  const sequelize = new Sequelize(DATABASE, USER, PASSWORD, {
    host: HOST,
    dialect: 'mysql',
    logging: (msg) => logger.info(Messages.info(modules.DB, actions.CONNECT, msg)),
  });

  // init models and add them to the exported db object
  db.Upload = require('./models/upload')(sequelize);
  db.Chunk = require('./models/chunk')(sequelize);

  // sync all models with database
  await sequelize.sync({ alter: true });
};
```

### éƒ¨ç½²

ç”Ÿäº§ç¯å¢ƒçš„éƒ¨ç½²é‡‡ç”¨äº†`docker-compose`ï¼Œä»£ç å¦‚ä¸‹ï¼š

**Dockerfile**

```yaml
FROM node:16-alpine3.11

# Create app directory
WORKDIR /usr/src/app

# A wildcard is used to ensure both package.json AND package-lock.json are copied
# where available (npm@5+)
COPY package*.json ./

# If you are building your code for production
# RUN npm ci --only=production

# Bundle app source
COPY . .

# Install app dependencies
RUN npm install
RUN npm run build:prod
```

**docker-compose.yml**

```yaml
version: "3.9"
services:
  web:
    build: .
    # sleep for 20 sec, wait for database server start
    command: sh -c "sleep 20 && npm start"
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: prod
    depends_on:
      - db
  db:
    image: mysql:8
    command: --default-authentication-plugin=mysql_native_password
    restart: always
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: pwd123
```

æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œéœ€è¦ç­‰æ•°æ®åº“æœåŠ¡å¯åŠ¨ï¼Œç„¶åå†å¯åŠ¨`web`æœåŠ¡ï¼Œä¸ç„¶ä¼šæŠ¥é”™ï¼Œæ‰€ä»¥ä»£ç ä¸­åŠ äº†20ç§’çš„å»¶è¿Ÿã€‚

**éƒ¨ç½²åˆ°heroku**

1. create `heroku.yml`

    ```yaml
    build:
      docker:
        web: Dockerfile
    run:
      web: npm run start:heroku
    ```

2. modify `package.json`

    ```yaml
    {
      "scripts": {
        "start:heroku": "NODE_ENV=heroku node ./bin/www"
      }
    }
    ```

3. deploy to heroku

    ```yaml
    # create heroku repos
    heroku create upload-demos
    heroku stack:set container 

    # when add addons, remind to config you billing card in heroku [important]
    # add mysql addons
    heroku addons:create cleardb:ignite 
    # get mysql connection url
    heroku config | grep CLEARDB_DATABASE_URL
    # will echo => DATABASE_URL: mysql://xxxxxxx:xxxxxx@xx-xxxx-east-xx.cleardb.com/heroku_9ab10c66a98486e?reconnect=true

    # set mysql database url
    heroku config:set DATABASE_URL='mysql://xxxxxxx:xxxxxx@xx-xxxx-east-xx.cleardb.com/heroku_9ab10c66a98486e?reconnect=true'

    # add heroku.js to src/db/config folder
    # use the DATABASE_URL which you get form prev step to config the js file
    module.exports = {
      HOST: 'xx-xxxx-east-xx.cleardb.com',
      USER: 'xxxxxxx',
      PASSWORD: 'xxxxxx',
      DATABASE: 'heroku_9ab10c66a98486e',
    };

    # push source code to remote
    git push heroku master
    ```

## å°ç»“

è‡³æ­¤æ‰€æœ‰çš„é—®é¢˜éƒ½å·²ç»è§£å†³äº†ï¼Œæ€»ä½“çš„ä¸€ä¸ªæ„Ÿå—æ˜¯å¤„ç†çš„ç»†èŠ‚éå¸¸å¤šï¼Œæœ‰äº›äº‹æƒ…è¿˜æ˜¯ä¸èƒ½åªæ˜¯çœ‹çœ‹ï¼ŒèŠ±æ—¶é—´åšå‡ºæ¥æ‰æ›´åŠ äº†è§£åŸç†ï¼Œæ›´åŠ æœ‰åŠ¨åŠ›å»å­¦æ–°çš„çŸ¥è¯†ã€‚

**çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œç»çŸ¥æ­¤äº‹è¦èº¬è¡Œã€‚**

åœ¨ä»£ç ä»“åº“[github](https://github.com/Rynxiao/file-examples)è¿˜æœ‰å¾ˆå¤šç»†èŠ‚ï¼ŒåŒ…æ‹¬æœ¬åœ°æœåŠ¡å™¨å¼€å‘é…ç½®ã€æ—¥å¿—å­˜å‚¨ç­‰ç­‰ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±`fork`äº†è§£ä¸‹ã€‚åˆ›ä½œä¸æ˜“ï¼Œæ±‚â­ï¸â­ï¸ã€‚

